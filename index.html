<!-- FILE-SEARCH WIDGET v2 -->
<div id="file-widget" style="max-width:900px;margin:0 auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial">
  <div style="background:#f6f7f9;border:1px solid #e5e7eb;border-radius:16px;padding:18px">
    <h2 style="margin:0 0 12px;font-size:26px;font-weight:800">Найти файл по ссылке</h2>

    <div style="display:flex;gap:10px;margin:12px 0 14px;flex-wrap:wrap">
      <a href="tel:+7XXXXXXXXXX" style="background:#16a34a;color:#fff;border-radius:12px;padding:12px 16px;text-decoration:none;font-weight:700">Позвонить</a>
      <a href="https://wa.me/7XXXXXXXXXX" target="_blank" rel="noopener" style="background:#22c55e;color:#fff;border-radius:12px;padding:12px 16px;text-decoration:none;font-weight:700">WhatsApp</a>
    </div>

    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:14px">
      <input id="q" type="search" inputmode="search" placeholder="Опишите файл: «драйвер», «прошивка», «инструкция»…"
             style="width:100%;padding:14px 16px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px;outline:none">
      <p style="margin:10px 0 12px;color:#6b7280">Начните ввод (минимум 2 буквы) — покажем найденные файлы. Или «Показать всё».</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="showAll" style="background:#111827;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer">Показать всё</button>
        <button id="resetClicks" style="background:#6b7280;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer">Сбросить счётчики кликов</button>
      </div>
    </div>

    <div style="background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:0;margin-top:14px;overflow:hidden">
      <div style="display:grid;grid-template-columns:1fr 110px 120px 110px;gap:0;background:#f9fafb;border-bottom:1px solid #e5e7eb;padding:12px 14px;font-weight:700">
        <div>Файл</div><div>Размер</div><div>Открыть</div><div>Клики</div>
      </div>
      <div id="rows"></div>
      <div id="empty" style="padding:14px;color:#6b7280;display:none">Ничего не найдено — попробуйте по-другому сформулировать</div>

      <!-- Пагинация -->
      <div id="pager" style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid #e5e7eb">
        <button id="prev" disabled style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">Назад</button>
        <div id="pageInfo" style="color:#374151">Стр. 1/1</div>
        <button id="next" disabled style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer">Вперёд</button>
      </div>
    </div>

    <p id="meta" style="color:#6b7280;margin:10px 2px 0">Загружено файлов: …</p>
    <details style="margin-top:6px;color:#6b7280"><summary>Админ-подсказка: ссылка на публикацию CSV</summary><div id="csv-hint" style="word-break:break-all"></div></details>
  </div>
</div>

<script>
(() => {
  // ==== НАСТРОЙКИ ====
  // ==== НАСТРОЙКИ ====
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQr5tjcoANOKmeK8Mx4B2nHKrHdprWIcVrMBGd1Iqo4NW3-0xO9dHaTGR5HWxFa3DWWOAl6AkxVF7Lw/pub?gid=0&single=true&output=csv";
const CACHE_TTL_MIN = 60;
const PAGE_SIZE = 20;
// ====================

  // ====================

  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  const rowsBox = $("#rows");
  const emptyBox = $("#empty");
  const meta = $("#meta");
  const q = $("#q");
  const showAllBtn = $("#showAll");
  const resetClicksBtn = $("#resetClicks");
  const hint = $("#csv-hint");

  const pager = $("#pager");
  const prevBtn = $("#prev");
  const nextBtn = $("#next");
  const pageInfo = $("#pageInfo");

  hint.textContent = CSV_URL;

  let DATA = [];     // весь CSV
  let FILTERED = []; // результат поиска
  let page = 1;      // текущая страница

  const norm = s => (s||"").toString().toLowerCase()
                     .normalize("NFKD")
                     .replace(/[ё]/g,"е")
                     .replace(/[\u0300-\u036f]/g,"")
                     .trim();

  const escapeHTML = s => (s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  const mark = (html, query) => {
    if (!query) return escapeHTML(html);
    try {
      const re = new RegExp("(" + query.replace(/[.*+?^${}()|[\]\\]/g,"\\$&") + ")", "ig");
      return escapeHTML(html).replace(re, "<mark>$1</mark>");
    } catch(_) { return escapeHTML(html); }
  };

  // CSV-парсер
  function parseCSV(text){
    const lines = text.replace(/\r/g,"").split("\n").filter(x=>x.trim().length);
    if (!lines.length) return [];
    const head = splitCSVLine(lines[0]).map(norm);
    return lines.slice(1).map(line => {
      const cells = splitCSVLine(line);
      const obj = {};
      head.forEach((h,i)=>obj[h]=cells[i] ?? "");
      return obj;
    });
  }
  function splitCSVLine(line){
    const out = []; let cur=""; let q=false;
    for (let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if (c === '"' ){ if (q && n === '"'){ cur+='"'; i++; } else { q=!q; } }
      else if (c === ',' && !q){ out.push(cur); cur=""; }
      else cur += c;
    }
    out.push(cur);
    return out;
  }

  // Кэш
  function loadCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return null;
      const {ts, data, url} = JSON.parse(raw);
      if(url !== CSV_URL) return null;
      if(Date.now() - ts > CACHE_TTL_MIN*60*1000) return null;
      return data;
    }catch{ return null; }
  }
  function saveCache(data){
    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({ts:Date.now(), data, url:CSV_URL}));
    }catch{}
  }

  async function loadCSV(url){
    const cached = loadCache();
    if (cached) return cached;
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const txt = await res.text();
    if(!txt.trim()) throw new Error("Пустой CSV");
    const data = parseCSV(txt);
    saveCache(data);
    return data;
  }

  // Нормализация полей
  function mapRow(r){
    const get = k => r[k] ?? r[k.toLowerCase()] ?? "";
    const name = get("name") || get("название") || get("file") || get("файл");
    const url  = get("url")  || get("ссылка") || get("link");
    const size = get("size") || get("размер");
    const tags = get("tags") || get("теги");
    const desc = get("desc") || get("описание");
    return {name, url, size, tags, desc};
  }

  // Счётчики кликов (per-URL)
  const CLICK_KEY = "file_search_clicks_v2";
  function getClicks(){ try{ return JSON.parse(localStorage.getItem(CLICK_KEY)||"{}"); }catch{ return {}; } }
  function setClicks(v){ try{ localStorage.setItem(CLICK_KEY, JSON.stringify(v)); }catch{} }
  function incClick(url){
    const m = getClicks();
    m[url] = (m[url]||0) + 1;
    setClicks(m);
  }

  function paginate(list, p, size){
    const total = Math.max(1, Math.ceil(list.length / size));
    const cur = Math.min(Math.max(1,p), total);
    const start = (cur-1)*size;
    return {slice:list.slice(start, start+size), cur, total};
  }

  function render(list, queryStr){
    const {slice, cur, total} = paginate(list, page, PAGE_SIZE);
    page = cur;

    const clicks = getClicks();
    rowsBox.innerHTML = slice.map(r=>{
      const a = mapRow(r);
      const title = a.desc ? `${a.name} — ${a.desc}` : a.name;
      const qn = norm(queryStr);
      const cnt = clicks[a.url] || 0;
      return `
        <div class="row" style="display:grid;grid-template-columns:1fr 110px 120px 110px;gap:0;border-top:1px solid #e5e7eb;padding:12px 14px;align-items:center">
          <div>
            <div style="font-weight:600">${mark(title, qn)}</div>
            ${a.tags ? `<div style="color:#6b7280;font-size:12px">#${escapeHTML(a.tags)}</div>` : ""}
          </div>
          <div>${escapeHTML(a.size||"—")}</div>
          <div>
            ${a.url ? `<a href="${escapeHTML(a.url)}" target="_blank" rel="noopener" data-url="${escapeHTML(a.url)}"
               class="open-btn" style="display:inline-block;background:#111827;color:#fff;text-decoration:none;border-radius:8px;padding:8px 12px;font-weight:700">Открыть</a>` : "—"}
          </div>
          <div data-clicks-for="${escapeHTML(a.url||'')}">${cnt}</div>
        </div>`;
    }).join("");

    emptyBox.style.display = slice.length ? "none" : "block";
    meta.textContent = `Загружено файлов: ${DATA.length} • Найдено: ${list.length}`;
    pageInfo.textContent = `Стр. ${cur} / ${total}`;
    prevBtn.disabled = cur<=1;
    nextBtn.disabled = cur>=total;

    // обработчик кликов по "Открыть"
    $$(".open-btn").forEach(a=>{
      a.addEventListener("click", () => {
        const u = a.getAttribute("data-url");
        incClick(u);
        const cell = document.querySelector('[data-clicks-for="'+CSS.escape(u)+'"]');
        if(cell) cell.textContent = (parseInt(cell.textContent)||0) + 1;
      }, {once:false});
    });
  }

  function doSearch(qstr){
    const n = norm(qstr);
    if (n.length < 2) { FILTERED = []; render([], n); return; }
    FILTERED = DATA.filter(r=>{
      const a = mapRow(r);
      const blob = [a.name,a.desc,a.tags,a.url].map(norm).join(" ");
      return blob.includes(n);
    });
    page = 1;
    render(FILTERED, qstr);
  }

  // События
  q.addEventListener("input", e => doSearch(e.target.value));
  showAllBtn.addEventListener("click", () => { page=1; FILTERED = DATA.slice(); render(FILTERED, ""); });
  resetClicksBtn.addEventListener("click", () => { localStorage.removeItem(CLICK_KEY); render(FILTERED.length?FILTERED:[], q.value); });

  prevBtn.addEventListener("click", () => { if(page>1){ page--; render(FILTERED.length?FILTERED:[], q.value); } });
  nextBtn.addEventListener("click", () => { page++; render(FILTERED.length?FILTERED:[], q.value); });

  // Инициализация
  (async () => {
    try {
      DATA = await loadCSV(CSV_URL);
      meta.textContent = `Загружено файлов: ${DATA.length}`;
      render([], "");
    } catch(err){
      rowsBox.innerHTML = `<div style="padding:14px;color:#b91c1c">Ошибка загрузки CSV: ${escapeHTML(err.message)}</div>`;
      emptyBox.style.display = "none";
      meta.textContent = "Загрузка не удалась";
      pager.style.display = "none";
    }
  })();
})();
</script>
